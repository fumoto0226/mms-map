<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>äº¤äº’å¼åœ°å›¾å›¾é’‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html, body {
      margin: 0; 
      padding: 0; 
      height: 100%; 
      overflow: hidden;
    }
    
    #map {
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%;
    }
    
    /* æ·»åŠ å›¾é’‰æŒ‰é’® */
    #addPinBtn {
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      z-index: 1000;
      background: #007bff; 
      color: white; 
      border: none; 
      border-radius: 50px;
      padding: 12px 24px; 
      font-size: 16px; 
      font-weight: bold;
      cursor: pointer; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    
    #addPinBtn:hover {
      background: #0056b3;
      transform: scale(1.05);
    }
    
    #addPinBtn.active {
      background: #28a745;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    /* å›¾é’‰ SVG å…ƒç´ æ ·å¼ */
    .pin-svg {
      position: absolute;
      width: 48px;
      height: 48px;
      cursor: pointer;
      transition: transform 0.3s ease;
      transform-origin: bottom center;
      z-index: 100;
      pointer-events: auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .pin-svg img {
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    
    /* éšè— Mapbox é»˜è®¤æ ‡è®° */
    .mapboxgl-marker {
      opacity: 0;
      pointer-events: none;
    }
    
    /* æ–‡å­—ä¿¡æ¯è¾“å…¥æ¡† */
    #pinEditor {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      padding: 24px;
      width: 90%;
      max-width: 400px;
      z-index: 2000;
      display: none;
    }
    
    #pinEditor.show {
      display: block;
      animation: fadeInScale 0.3s ease;
    }
    
    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }
    
    #pinEditor h3 {
      margin: 0 0 16px 0;
      color: #333;
      font-size: 20px;
    }
    
    #pinTextInput {
      width: 100%;
      height: 80px;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      font-size: 16px;
      resize: vertical;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    
    #pinTextInput:focus {
      outline: none;
      border-color: #007bff;
    }
    
    .editor-buttons {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    
    .editor-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    #publishBtn {
      background: #007bff;
      color: white;
    }
    
    #publishBtn:hover {
      background: #0056b3;
      transform: translateY(-2px);
    }
    
    #cancelBtn {
      background: #f0f0f0;
      color: #666;
    }
    
    #cancelBtn:hover {
      background: #e0e0e0;
      transform: translateY(-2px);
    }
    
    /* å›¾é’‰æ–‡å­—æµ®çª— */
    #pinPopup {
      position: absolute;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      padding: 12px 16px;
      max-width: 250px;
      z-index: 500;
      pointer-events: none;
      font-size: 15px;
      font-weight: 500;
      color: #333;
      opacity: 0;
      /* é»˜è®¤çŠ¶æ€ï¼šåœ¨ä¸‹æ–¹ï¼Œç¼©å° */
      transform: translateX(-50%) translateY(20px) scale(0.8);
      /* åªå¯¹ opacity å’Œ transform æ·»åŠ è¿‡æ¸¡ï¼Œleft/top ä½ç½®å˜åŒ–ä¸éœ€è¦è¿‡æ¸¡ */
      transition: opacity 0.35s cubic-bezier(0.34, 1.56, 0.64, 1), 
                  transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    #pinPopup.show {
      opacity: 1;
      /* æ˜¾ç¤ºçŠ¶æ€ï¼šå±…ä¸­ï¼Œæ­£å¸¸å¤§å° */
      transform: translateX(-50%) translateY(0) scale(1);
    }
    
    /* æµ®çª—å°ä¸‰è§’ */
    #pinPopup::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid white;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="addPinBtn">â• æ·»åŠ å›¾é’‰</button>
  
  <!-- æ–‡å­—ä¿¡æ¯è¾“å…¥æ¡† -->
  <div id="pinEditor">
    <h3>æ·»åŠ å›¾é’‰ä¿¡æ¯</h3>
    <textarea id="pinTextInput" placeholder="è¯·è¾“å…¥å›¾é’‰çš„æ–‡å­—ä¿¡æ¯..."></textarea>
    <div class="editor-buttons">
      <button id="cancelBtn">å–æ¶ˆ</button>
      <button id="publishBtn">å‘å¸ƒ</button>
    </div>
  </div>
  
  <!-- å›¾é’‰æ–‡å­—æµ®çª— -->
  <div id="pinPopup"></div>

  <script>
    // åˆå§‹åŒ–åœ°å›¾
    mapboxgl.accessToken = "pk.eyJ1IjoiZnVtb3RvIiwiYSI6ImNtYXhqbGZ4bDBiOWwybHB3a3R5dmk3Z2kifQ.vXgn2UF6HVT0cnnQRmLO1A";
    
    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/fumoto/cmc7scka301ds01r70bw30pbf",
      center: [139.7006, 35.6896], // æ–°å®¿ç«™é™„è¿‘
      zoom: 12
    });

    // å­˜å‚¨æ‰€æœ‰å›¾é’‰
    const pins = [];
    let currentPopupPin = null; // å½“å‰æ˜¾ç¤ºæµ®çª—çš„å›¾é’‰
    
    // è·å– DOM å…ƒç´ 
    const pinEditor = document.getElementById('pinEditor');
    const pinTextInput = document.getElementById('pinTextInput');
    const pinPopup = document.getElementById('pinPopup');
    const publishBtn = document.getElementById('publishBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    
    // åˆ›å»ºå›¾é’‰çš„å‡½æ•°
    function createPin(lngLat, text = '') {
      // åˆ›å»ºéšè—çš„ Mapbox æ ‡è®°ç”¨äºåœ°ç†å®šä½
      const el = document.createElement('div');
      el.style.width = '1px';
      el.style.height = '1px';
      el.style.opacity = '0';
      el.style.pointerEvents = 'none';
      
      const marker = new mapboxgl.Marker({
        element: el,
        anchor: 'bottom'
      })
        .setLngLat(lngLat)
        .addTo(map);

      // åˆ›å»º SVG å›¾é’‰å…ƒç´ 
      const svgElement = document.createElement('div');
      svgElement.className = 'pin-svg';
      
      const svgImg = document.createElement('img');
      svgImg.src = 'img/map01.svg';
      svgElement.appendChild(svgImg);
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(svgElement);

      // æ›´æ–°å›¾é’‰ä½ç½®çš„å‡½æ•°
      function updatePosition() {
        const point = map.project(lngLat);
        const container = map.getContainer();
        const rect = container.getBoundingClientRect();
        
        svgElement.style.left = (rect.left + point.x - 24) + 'px'; // 24px æ˜¯å®½åº¦çš„ä¸€åŠ
        svgElement.style.top = (rect.top + point.y - 48) + 'px'; // 48px æ˜¯é«˜åº¦ï¼Œé”šç‚¹åœ¨åº•éƒ¨
      }

      // ç›‘å¬åœ°å›¾äº‹ä»¶æ›´æ–°ä½ç½®
      map.on('move', updatePosition);
      map.on('zoom', updatePosition);
      map.on('resize', updatePosition);

      // åˆå§‹åŒ–ä½ç½®
      updatePosition();

      // ç‚¹å‡»äº‹ä»¶ - æ˜¾ç¤ºæ–‡å­—æµ®çª—
      svgElement.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log('å›¾é’‰è¢«ç‚¹å‡»:', text, lngLat);
        
        // æ˜¾ç¤ºè¯¥å›¾é’‰çš„æ–‡å­—æµ®çª—
        showPinPopup(pinData);
      });

      // é¼ æ ‡æ‚¬åœæ•ˆæœ
      svgElement.addEventListener('mouseenter', () => {
        svgElement.setAttribute('_hover', '1');
        if (svgElement.getAttribute('_active') !== '1') {
          svgElement.style.transform = 'scale(1.3)';
        }
      });
      
      svgElement.addEventListener('mouseleave', () => {
        svgElement.setAttribute('_hover', '0');
        if (svgElement.getAttribute('_active') !== '1') {
          svgElement.style.transform = 'scale(1)';
        }
      });
      
      // é¼ æ ‡æŒ‰ä¸‹æ•ˆæœ
      svgElement.addEventListener('mousedown', () => {
        svgElement.setAttribute('_active', '1');
        svgElement.style.transform = 'scale(0.92)';
      });
      
      svgElement.addEventListener('mouseup', () => {
        svgElement.setAttribute('_active', '0');
        if (svgElement.getAttribute('_hover') === '1') {
          svgElement.style.transform = 'scale(1.3)';
        } else {
          svgElement.style.transform = 'scale(1)';
        }
      });

      // ä¿å­˜å›¾é’‰ä¿¡æ¯
      const pinData = {
        marker,
        svgElement,
        lngLat,
        text,
        updatePosition
      };
      
      pins.push(pinData);
      return pinData;
    }
    
    // æ˜¾ç¤ºå›¾é’‰æ–‡å­—æµ®çª—
    function showPinPopup(pinData) {
      if (!pinData.text) return; // å¦‚æœæ²¡æœ‰æ–‡å­—ä¿¡æ¯åˆ™ä¸æ˜¾ç¤º
      
      currentPopupPin = pinData;
      pinPopup.textContent = pinData.text;
      
      // å…ˆæ›´æ–°ä½ç½®ï¼Œå†æ˜¾ç¤ºï¼ˆé¿å…é—ªç°ï¼‰
      updatePopupPosition();
      
      // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ä½ç½®æ›´æ–°åå†æ˜¾ç¤º
      requestAnimationFrame(() => {
        pinPopup.classList.add('show');
      });
    }
    
    // éšè—å›¾é’‰æ–‡å­—æµ®çª—
    function hidePopup() {
      pinPopup.classList.remove('show');
      currentPopupPin = null;
    }
    
    // æ›´æ–°æµ®çª—ä½ç½®
    function updatePopupPosition() {
      if (!currentPopupPin) return;
      
      const point = map.project(currentPopupPin.lngLat);
      const container = map.getContainer();
      const rect = container.getBoundingClientRect();
      
      // æµ®çª—æ˜¾ç¤ºåœ¨å›¾é’‰ä¸Šæ–¹ï¼Œåç§» 120pxï¼ˆå›¾é’‰é«˜åº¦ + æ›´å¤šé—´è·ï¼‰
      // åªè®¾ç½® left å’Œ topï¼Œtransform ç”± CSS æ§åˆ¶ï¼ˆå±…ä¸­å’ŒåŠ¨ç”»ï¼‰
      pinPopup.style.left = (rect.left + point.x) + 'px';
      pinPopup.style.top = (rect.top + point.y - 120) + 'px';
    }
    
    // ç›‘å¬åœ°å›¾ç§»åŠ¨æ›´æ–°æµ®çª—ä½ç½®
    map.on('move', updatePopupPosition);
    map.on('zoom', updatePopupPosition);

    // æ·»åŠ å›¾é’‰æ¨¡å¼
    let isAddingPin = false;
    let pendingPinLocation = null; // å¾…æ·»åŠ å›¾é’‰çš„ä½ç½®
    const addBtn = document.getElementById("addPinBtn");

    addBtn.addEventListener("click", () => {
      isAddingPin = !isAddingPin;
      
      if (isAddingPin) {
        addBtn.textContent = "ğŸŸ¢ ç‚¹å‡»åœ°å›¾æ”¾ç½®å›¾é’‰";
        addBtn.classList.add("active");
        map.getCanvas().style.cursor = 'crosshair';
      } else {
        addBtn.textContent = "â• æ·»åŠ å›¾é’‰";
        addBtn.classList.remove("active");
        map.getCanvas().style.cursor = '';
      }
    });

    // ç‚¹å‡»åœ°å›¾æ—¶çš„å¤„ç†
    map.on("click", (e) => {
      // å¦‚æœæ­£åœ¨æ·»åŠ å›¾é’‰æ¨¡å¼ï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†
      if (isAddingPin) {
        pendingPinLocation = [e.lngLat.lng, e.lngLat.lat];
        console.log("é€‰æ‹©å›¾é’‰ä½ç½®:", pendingPinLocation);
        
        // æ˜¾ç¤ºè¾“å…¥æ¡†
        pinEditor.classList.add('show');
        pinTextInput.value = '';
        pinTextInput.focus();
        
        // é€€å‡ºæ·»åŠ æ¨¡å¼
        isAddingPin = false;
        addBtn.textContent = "â• æ·»åŠ å›¾é’‰";
        addBtn.classList.remove("active");
        map.getCanvas().style.cursor = '';
      } else {
        // ç‚¹å‡»åœ°å›¾å…¶ä»–åœ°æ–¹ï¼Œéšè—æµ®çª—
        hidePopup();
      }
    });
    
    // å‘å¸ƒæŒ‰é’® - åˆ›å»ºå›¾é’‰
    publishBtn.addEventListener('click', () => {
      const text = pinTextInput.value.trim();
      
      if (!text) {
        alert('è¯·è¾“å…¥æ–‡å­—ä¿¡æ¯');
        return;
      }
      
      if (pendingPinLocation) {
        console.log("åˆ›å»ºå›¾é’‰:", pendingPinLocation, text);
        createPin(pendingPinLocation, text);
        
        // æ¸…ç†
        pinEditor.classList.remove('show');
        pinTextInput.value = '';
        pendingPinLocation = null;
      }
    });
    
    // å–æ¶ˆæŒ‰é’®
    cancelBtn.addEventListener('click', () => {
      pinEditor.classList.remove('show');
      pinTextInput.value = '';
      pendingPinLocation = null;
    });

    // åœ°å›¾åŠ è½½å®Œæˆåï¼Œåœ¨æ–°å®¿ç«™æ·»åŠ æµ‹è¯•å›¾é’‰
    map.on('load', () => {
      // æ–°å®¿ç«™åæ ‡ï¼Œå¸¦æœ‰æ–‡å­—ä¿¡æ¯
      const shinjukuStation = [139.7006, 35.6896];
      createPin(shinjukuStation, 'æ–°å®¿ç«™');
      
      console.log('å·²åœ¨æ–°å®¿ç«™æ·»åŠ æµ‹è¯•å›¾é’‰ï¼Œç‚¹å‡»å›¾é’‰æŸ¥çœ‹æ–‡å­—ä¿¡æ¯');
    });
  </script>
</body>
</html>
